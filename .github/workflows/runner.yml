name: üé¨ Action
on:
  pull_request:
  workflow_dispatch:
    inputs:
      compile:
        description: 'manual'

concurrency:
  group: ci-${{github.actor}}-${{github.run_number}}-runner
  cancel-in-progress: true

jobs:
  android-build:
    name: üü¢ Android
    uses: ./.github/workflows/android_builds.yml

  ios-build:
    name: ‚ö™ iOS
    uses: ./.github/workflows/ios_builds.yml

  javascript-build:
    name: üåê JavaScript
    uses: ./.github/workflows/javascript_builds.yml

  linux-build:
    name: üü® Linux
    uses: ./.github/workflows/linux_builds.yml

  macos-build:
    name: ‚¨ú macOS
    uses: ./.github/workflows/macos_builds.yml

  windows-build:
    name: üü¶ Windows
    uses: ./.github/workflows/windows_builds.yml

  release:
    name: üî• Release
    needs: [android-build, ios-build, javascript-build, linux-build, macos-build, windows-build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Get SHA
        id: sha
        run: echo "::set-output name=sha7::$(git rev-parse --short HEAD)"
      
      - name: Setup directories
        run: mkdir -p artifacts/processed
      
      - name: Archive Source
        run: |
          git archive --format=zip HEAD -o artifacts/processed/GDX-source.zip
      
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: ls -R artifacts/
          
      - name: Process and Archive artifacts
        run: |
          cd artifacts
          process_artifacts() {
            local platform=$1
            if [ -d "$platform" ]; then
              rename_files "$platform"
              compress_files "$platform"
            fi
          }

          rename_files() {
              if [ $(find "$platform" -maxdepth 1 -name "*.zip" | wc -l) -eq 0 ] && [ -n "$(ls -A $platform)" ]; then
            # Rename files
            find "$platform" -type f -name "godot*" -exec sh -c '
              new_name=$(echo "{}" | sed "s/godot/gdx/g")
              mv "{}" "$new_name"
            ' \;
          }

          compress_files() {
            local platform=$1
            # Compress files
            if [ ! -f "$platform"/*.zip ] && [ -n "$(ls -A $platform)" ]; then
              zip -r "processed/GDX-${platform^}.zip" "$platform"/*
            elif [ -f "$platform"/*.zip ]; then
              for zipfile in "$platform"/*.zip; do
                cp "$zipfile" "processed/GDX-${platform^}-$(basename "$zipfile")"
              done
            fi
          }

          for platform in android ios javascript linux macos windows; do
            process_artifacts "$platform"
          done

      - name: Verify artifacts
        run: |
          echo "Available files for release:"
          ls -la artifacts/processed/
          
      - name: Create Tag
        run: |
          git tag "v${{ steps.sha.outputs.sha7 }}"
          git push origin "v${{ steps.sha.outputs.sha7 }}"
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.sha.outputs.sha7 }}
          tag_name: v${{ steps.sha.outputs.sha7 }}
          draft: true
          files: ./artifacts/processed/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
