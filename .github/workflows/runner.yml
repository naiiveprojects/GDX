name: ðŸŽ¬ Action
on:
  pull_request:
  workflow_dispatch:
    inputs:
      compile:
        description: 'manual'

concurrency:
  group: ci-${{github.actor}}-${{github.head_ref || github.run_number}}-${{github.ref}}-runner
  cancel-in-progress: true

jobs:
  android-build:
    name: ðŸŸ¢ Android
    uses: ./.github/workflows/android_builds.yml

  ios-build:
    name: âšª iOS
    uses: ./.github/workflows/ios_builds.yml

  javascript-build:
    name: ðŸŒ JavaScript
    uses: ./.github/workflows/javascript_builds.yml

  linux-build:
    name: ðŸŸ¨ Linux
    uses: ./.github/workflows/linux_builds.yml

  macos-build:
    name: â¬œ macOS
    uses: ./.github/workflows/macos_builds.yml

  windows-build:
    name: ðŸŸ¦ Windows
    uses: ./.github/workflows/windows_builds.yml

  release:
    name: ðŸ”¥ Release
    needs: [android-build, ios-build, javascript-build, linux-build, macos-build, windows-build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Get SHA
        id: sha
        run: echo "sha7=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      
      - name: Archive Source
        run: |
          git archive --format=zip HEAD -o GDX-source.zip
          mkdir -p artifacts/processed
          mv GDX-source.zip artifacts/processed/
      
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: ls -R artifacts/
          
      - name: Process and Archive artifacts
        run: |
          cd artifacts
          mkdir -p processed
          
          for platform in android ios javascript linux macos windows; do
            if [ -d "$platform" ]; then
              # Rename
              find "$platform" -type f -name "godot*" -exec sh -c '
                new_name=$(echo "{}" | sed "s/godot/gdx/g")
                mv "{}" "$new_name"
              ' \;
              
              # Compress
              if [ ! -f "$platform"/*.zip ] && [ -n "$(ls -A $platform)" ]; then
                zip -r "processed/GDX-${platform^}.zip" "$platform"/*
              elif [ -f "$platform"/*.zip ]; then
                find "$platform" -name "*.zip" -exec cp {} "processed/GDX-${platform^}.zip" \;
              fi
            fi
          done
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.sha.outputs.sha7 }}
          draft: true
          files: artifacts/processed/GDX-*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
